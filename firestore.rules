rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Global rule: Authenticated users can read/write data
    // For production, you would restrict these by user ID.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // --- Cost Centers ---
    match /cost_centers/{centerId} {
      allow create: if request.resource.data.name != null;
    }

    // --- Categories ---
    match /budget_categories/{categoryId} {
      allow create: if request.resource.data.category != null 
                    && request.resource.data.costCenterId != null
                    && request.resource.data.budgetType in ['OTE', 'PME'];
    }

    // --- Expenses ---
    match /expenses/{expenseId} {
      allow create: if request.resource.data.amount > 0 
                    && request.resource.data.remarks != "" 
                    && request.resource.data.costCenterId != null
                    && request.resource.data.moneySource in ['PERSONAL', 'WALLET'];
    }

    // --- Donations ---
    match /donations/{donationId} {
      allow create: if request.resource.data.amount > 0 
                    && request.resource.data.costCenterId != null
                    && request.resource.data.mode in ['MERGE_TO_BUDGET', 'WALLET'];
    }
    
    // --- Allocations ---
    match /budget_allocations/{allocationId} {
      allow create: if request.resource.data.amount > 0 
                    && request.resource.data.costCenterId != null
                    && request.resource.data.budgetType in ['OTE', 'PME'];
    }

    // --- Global collections (no costCenterId needed) ---
    match /fund_transfers/{transferId} {
      allow write: if request.resource.data.amount > 0;
    }
    match /personal_adjustments/{adjId} {
      allow write: if request.resource.data.amount != 0;
    }
    match /fixed_amounts/{fixedId} {
      allow read, write: if request.auth != null;
    }
    match /personal_meta/{metaId} {
      allow read, write: if request.auth != null;
    }
  }
}
